name: Weekly PFD Top-Up

on:
  workflow_dispatch:
  # Automatically trigger every Monday at 1:00 AM UTC
  schedule:
    - cron: '0 1 * * 1'  # ...Format: Minute Hour Day Month Weekday (UTC timezone)

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Check if on main branch  # ...exit if not on main branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "This workflow is designed to run on main only."
          exit 0

      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true  # ...caches installed dependencies for faster subsequent runs
          cache-dependency-glob: "uv.lock"  # ...cache is invalidated if uv.lock changes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install Project Dependencies via UV
        run: uv sync

      - name: Run the PFD Top-Up Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          uv run python scripts/update_reports.py

      - name: Display Summary in Actions UI
        if: always()
        run: |
          summary_file=".github/workflows/update_summary.txt"
          echo "**Top-up Summary:**" >> $GITHUB_STEP_SUMMARY
          if [ -f "$summary_file" ]; then
            cat "$summary_file" >> $GITHUB_STEP_SUMMARY
          else
            echo "Summary file ($summary_file) not found." >> $GITHUB_STEP_SUMMARY
            echo "Python script output (from previous step) should indicate reason." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update report count in docs
        run: uv run python scripts/update_report_count.py
  
      - name: Commit & Push Changes
        # (...only if the script indicated changes by creating the summary file)
        if: github.ref == 'refs/heads/main'
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            src/pfd_toolkit/data/all_reports.csv
            docs/index.md
          default_author: github_actions
          message: "ðŸ¤– Auto PFD dataset top-up"
          pull: '--rebase --autostash' # ...pull from origin before pushing
          push: true