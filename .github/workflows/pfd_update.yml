name: Weekly PFD Top-Up

on:
  workflow_dispatch:
  # Automatically trigger every Monday at 1:00 AM UTC
  schedule:
    - cron: '0 1 * * 1'  # ...Format: Minute Hour Day Month Weekday (UTC timezone)

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Check if on main branch  # ...exit if not on main branch
        if: github.ref != 'refs/heads/main'
        run: |
          echo "This workflow is designed to run on main only."
          exit 0

      - name: Checkout Repository Code
        uses: actions/checkout@v4

      - name: DEBUG-- Inspect CSV immediately after checkout
        id: inspect_after_checkout 
        run: |
          echo "=== Inspecting CSV after checkout ==="
          TARGET_CSV="src/pfd_toolkit/data/all_reports.csv"
          echo "Commit SHA being used: ${{ github.sha }}"
          if [ -f "$TARGET_CSV" ]; then
            echo "File exists: $TARGET_CSV"
            echo "Line count (wc -l):"
            wc -l "$TARGET_CSV"
            echo "Head of file (first 5 lines):"
            head -n 5 "$TARGET_CSV"
            echo "Tail of file (last 5 lines):"
            tail -n 5 "$TARGET_CSV"
            echo "MD5sum:"
            md5sum "$TARGET_CSV"
            echo "SHA256sum:"
            sha256sum "$TARGET_CSV"
          else
            echo "File NOT FOUND: $TARGET_CSV"
            echo "Listing directory contents of src/pfd_toolkit/data/:"
            ls -la src/pfd_toolkit/data/ || echo "Directory src/pfd_toolkit/data/ not found"
            echo "Listing directory contents of src/pfd_toolkit/:"
            ls -la src/pfd_toolkit/ || echo "Directory src/pfd_toolkit/ not found"
            echo "Listing directory contents of src/:"
            ls -la src/ || echo "Directory src/ not found"
            echo "Listing current directory (PWD: $(pwd)):"
            ls -la
          fi
          echo "Current working directory: $(pwd)"

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true  # ...caches installed dependencies for faster subsequent runs
          cache-dependency-glob: "uv.lock"  # ...cache is invalidated if uv.lock changes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install Project Dependencies via UV
        run: uv sync

      - name: DEBUG-- Inspect CSV before Python script runs
        id: inspect_before_script 
        run: |
          echo "=== Inspecting CSV before Python script run (after uv sync) ==="
          TARGET_CSV="src/pfd_toolkit/data/all_reports.csv"
          if [ -f "$TARGET_CSV" ]; then
            echo "File exists: $TARGET_CSV"
            echo "Line count (wc -l):"
            wc -l "$TARGET_CSV"
            echo "MD5sum:"
            md5sum "$TARGET_CSV"
            echo "SHA256sum:"
            sha256sum "$TARGET_CSV"
          else
            echo "File NOT FOUND: $TARGET_CSV"
          fi
          echo "Python version via uv run:"
          uv run python -V
          echo "Pandas version via uv run:"
          uv run python -c "import pandas; print(f'Pandas version: {pandas.__version__}')"


      - name: Run the PFD Top-Up Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Current working directory before running script: $(pwd)"
          uv run python scripts/update_reports.py

      - name: Display Summary in Actions UI
        if: always()
        run: |
          summary_file=".github/workflows/update_summary.txt" # Corrected variable name
          echo "### Top-up Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "$summary_file" ]; then # Use corrected variable name
            cat "$summary_file" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ Summary file ($summary_file) not found." >> $GITHUB_STEP_SUMMARY
            echo "Python script output (from previous step) should indicate reason." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit & Push Changes
        # (Only run if the script indicated changes by creating the summary file)
        if: github.ref == 'refs/heads/main'
        uses: EndBug/add-and-commit@v9
        with:
          add: src/pfd_toolkit/data/all_reports.csv
          default_author: github_actions
          message: "🤖 Auto PFD dataset top-up"
          pull: '--rebase --autostash' # ...pull from origin before pushing
          push: true