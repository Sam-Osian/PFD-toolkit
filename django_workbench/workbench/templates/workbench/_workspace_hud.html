<section class="explore-action-rail-wrap reveal-up">
    <div class="explore-action-rail" role="toolbar" aria-label="Workspace controls">
        <div class="explore-action-rail__stats" aria-label="Workspace summary">
            <button type="button" class="explore-top-stat explore-top-stat--interactive" data-topbar-open="report-limit" title="Set report limit">
                <span class="explore-top-stat__label">Reports in view</span>
                <span class="explore-top-stat__value">{{ reports_count }}</span>
            </button>
            <button type="button" class="explore-top-stat explore-top-stat--interactive" data-topbar-open="date-range" title="Set report date range">
                <span class="explore-top-stat__label">Earliest / latest report</span>
                <span class="explore-top-stat__value">{{ earliest_display }} - {{ latest_display }}</span>
            </button>
            <button type="button" class="explore-top-stat explore-top-stat--status explore-top-stat--interactive" data-topbar-open="llm-settings" title="Edit LLM settings">
                <span class="explore-top-stat__label">LLM status</span>
                <span class="explore-top-stat__value explore-status-value">
                    <span class="explore-status-dot {% if llm_ready %}is-ready{% else %}is-not-ready{% endif %}" aria-hidden="true"></span>
                    {% if llm_ready %}Initialised{% else %}Not initialised{% endif %}
                </span>
            </button>
        </div>

        <div class="explore-action-rail__controls">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="undo">
                <button type="submit" class="action-rail-btn action-rail-btn--compact" {% if history_depth == 0 %}disabled{% endif %} aria-label="Undo" title="Undo{% if history_depth %} ({{ history_depth }}){% endif %}">
                    <i class="hgi hgi-stroke hgi-undo action-rail-btn__icon"></i>
                    <span>Undo</span>
                </button>
            </form>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="redo">
                <button type="submit" class="action-rail-btn action-rail-btn--compact" {% if redo_depth == 0 %}disabled{% endif %} aria-label="Redo" title="Redo{% if redo_depth %} ({{ redo_depth }}){% endif %}">
                    <i class="hgi hgi-stroke hgi-redo action-rail-btn__icon"></i>
                    <span>Redo</span>
                </button>
            </form>
            <button type="button" class="action-rail-btn action-rail-btn--icon action-rail-btn--danger" data-start-over-open {% if not workspace_active %}disabled{% endif %} aria-label="Start over" title="Start over">
                <i class="hgi hgi-stroke hgi-refresh action-rail-btn__icon"></i>
                <span class="sr-only">Start over</span>
            </button>
            <button type="button" class="action-rail-btn action-rail-btn--download" data-download-open aria-label="Download reports" {% if not dataset_available %}disabled{% endif %}>
                <i class="hgi hgi-stroke hgi-download-01 action-rail-btn__share-mark" aria-hidden="true"></i>
                <span>Download reports</span>
            </button>
            <button type="button" class="action-rail-btn action-rail-btn--share" aria-label="Share">
                <i class="hgi hgi-stroke hgi-user action-rail-btn__share-mark" aria-hidden="true"></i>
                <span>Share</span>
            </button>
            <div class="download-popover hidden" id="download-popover" role="dialog" aria-label="Download reports options">
                <form method="post" class="download-bundle-form">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="download_bundle">
                    <label class="checkbox"><input type="checkbox" name="download_include_dataset" checked> <span>Working dataset</span></label>
                    <label class="checkbox"><input type="checkbox" name="download_include_theme" {% if has_theme_summary %}checked{% endif %} {% if not has_theme_summary %}disabled{% endif %}> <span>Theme table</span></label>
                    <label class="checkbox"><input type="checkbox" name="download_include_feature_grid" {% if has_feature_grid %}checked{% endif %} {% if not has_feature_grid %}disabled{% endif %}> <span>Custom feature grid</span></label>
                    <label class="checkbox"><input type="checkbox" name="download_include_script"> <span>Reproducible Python script</span></label>
                    <div class="download-popover__actions">
                        <button type="button" class="button-secondary" data-download-cancel>Cancel</button>
                        <button type="submit" class="button-primary">Download</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<div class="topbar-popover-backdrop hidden" id="report-limit-popover" aria-modal="true" role="dialog" aria-labelledby="report-limit-title">
    <section class="topbar-popover">
        <div class="topbar-popover__head">
            <span class="section-kicker">Quick settings</span>
            <h3 id="report-limit-title">Reports in view</h3>
            <p>Set how many recent reports to load into the workspace.</p>
        </div>
        <form method="post" class="topbar-popover-form js-ai-reset-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="load_reports">
            <input type="hidden" name="report_start_date" value="{{ report_start_date }}">
            <input type="hidden" name="report_end_date" value="{{ report_end_date }}">
            <div class="topbar-popover-field">
                <label for="topbar_report_limit_number">Number of reports</label>
                <div class="topbar-limit-inputs">
                    <input id="topbar_report_limit_slider" type="range" min="1" max="7000" step="1" value="{{ report_limit_for_slider }}" data-topbar-limit-slider>
                    <input id="topbar_report_limit_number" name="n_reports" type="number" min="1" step="1" value="{{ report_limit|default:report_limit_for_slider }}" data-topbar-limit-number>
                </div>
                <small class="field-help">Use the slider for quick changes or enter an exact number.</small>
            </div>
            <div class="topbar-popover__actions">
                <button type="button" class="button-secondary" data-topbar-close>Cancel</button>
                <button type="submit" class="button-primary">Load reports</button>
            </div>
        </form>
    </section>
</div>

<div class="topbar-popover-backdrop hidden" id="date-range-popover" aria-modal="true" role="dialog" aria-labelledby="date-range-title">
    <section class="topbar-popover">
        <div class="topbar-popover__head">
            <span class="section-kicker">Quick settings</span>
            <h3 id="date-range-title">Report date range</h3>
            <p>Choose the start and end dates to load reports. Use DD/MM/YYYY format.</p>
        </div>
        <form method="post" class="topbar-popover-form js-ai-reset-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="load_reports">
            <input type="hidden" name="n_reports" value="{{ report_limit|default_if_none:'' }}">
            <div class="topbar-date-grid">
                <div class="topbar-popover-field">
                    <label for="topbar_report_start_date">Start date (DD/MM/YYYY)</label>
                    <input id="topbar_report_start_date" name="report_start_date" type="text" inputmode="numeric" placeholder="e.g. 01/01/2013" value="{{ report_start_date_display }}" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" maxlength="10" required autocomplete="off">
                </div>
                <div class="topbar-popover-field">
                    <label for="topbar_report_end_date">End date (DD/MM/YYYY)</label>
                    <input id="topbar_report_end_date" name="report_end_date" type="text" inputmode="numeric" placeholder="e.g. 11/02/2026" value="{{ report_end_date_display }}" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}" maxlength="10" required autocomplete="off">
                </div>
            </div>
            <div class="topbar-popover__actions">
                <button type="button" class="button-secondary" data-topbar-close>Cancel</button>
                <button type="submit" class="button-primary">Load reports</button>
            </div>
        </form>
    </section>
</div>

<div class="topbar-popover-backdrop hidden" id="llm-settings-popover" aria-modal="true" role="dialog" aria-labelledby="llm-settings-title">
    <section class="topbar-popover">
        <div class="topbar-popover__head">
            <span class="section-kicker">Quick settings</span>
            <h3 id="llm-settings-title">LLM settings</h3>
            <p>Update your model provider and credentials without leaving Explore.</p>
        </div>
        <form method="post" class="topbar-popover-form" id="topbar-llm-form">
            {% csrf_token %}
            <input type="hidden" name="action" value="save_settings">

            <div class="topbar-popover-field">
                <label for="topbar_provider_override">Provider</label>
                <select id="topbar_provider_override" name="provider_override">
                    <option value="OpenAI" {% if provider == 'OpenAI' %}selected{% endif %}>OpenAI</option>
                    <option value="OpenRouter" {% if provider == 'OpenRouter' %}selected{% endif %}>OpenRouter</option>
                </select>
            </div>

            <div class="topbar-provider-fields {% if provider == 'OpenRouter' %}hidden{% endif %}" id="topbar-openai-fields">
                <div class="topbar-popover-field">
                    <label for="topbar_openai_api_key">OpenAI API</label>
                    <input id="topbar_openai_api_key" name="openai_api_key" type="password" value="{{ openai_api_key }}" autocomplete="off">
                </div>
            </div>

            <div class="topbar-provider-fields {% if provider != 'OpenRouter' %}hidden{% endif %}" id="topbar-openrouter-fields">
                <div class="topbar-popover-field">
                    <label for="topbar_openrouter_api_key">OpenRouter API</label>
                    <input id="topbar_openrouter_api_key" name="openrouter_api_key" type="password" value="{{ openrouter_api_key }}" autocomplete="off">
                </div>
            </div>

            <div class="topbar-date-grid">
                <div class="topbar-popover-field">
                    <label for="topbar_model_name">Model</label>
                    <select id="topbar_model_name" name="model_name">
                        <option value="gpt-4.1-mini" {% if model_name == 'gpt-4.1-mini' %}selected{% endif %}>gpt-4.1-mini</option>
                        <option value="gpt-4.1" {% if model_name == 'gpt-4.1' %}selected{% endif %}>gpt-4.1</option>
                    </select>
                </div>
                <div class="topbar-popover-field">
                    <label for="topbar_max_parallel_workers">Max parallel workers</label>
                    <input id="topbar_max_parallel_workers" name="max_parallel_workers" type="number" min="1" max="32" step="1" value="{{ max_parallel_workers }}">
                </div>
            </div>

            <div class="topbar-popover__actions">
                <button type="button" class="button-secondary" data-topbar-close>Cancel</button>
                <button type="submit" class="button-primary">Save settings</button>
            </div>
        </form>
    </section>
</div>

<div class="confirm-modal-backdrop hidden" id="topbar-ai-reset-confirm" aria-modal="true" role="dialog" aria-labelledby="topbar-ai-reset-title" data-ai-features-used="{% if ai_features_used %}1{% else %}0{% endif %}">
    <section class="confirm-modal">
        <h3 id="topbar-ai-reset-title">Reload reports and reset AI outputs?</h3>
        <p>Changing report scope will reload the dataset and clear Filter, Discover, and Extract outputs for this workspace.</p>
        <div class="confirm-modal__actions">
            <button type="button" class="button-secondary" data-topbar-ai-reset-cancel>Cancel</button>
            <button type="button" class="button-primary" data-topbar-ai-reset-confirm>Confirm and continue</button>
        </div>
    </section>
</div>

<div class="confirm-modal-backdrop hidden" id="start-over-confirm" aria-modal="true" role="dialog" aria-labelledby="start-over-confirm-title">
    <section class="confirm-modal">
        <h3 id="start-over-confirm-title">Start over?</h3>
        <p>This will clear the active workspace state and return to the loaded dataset.</p>
        <div class="confirm-modal__actions">
            <button type="button" class="button-secondary" data-start-over-cancel>Cancel</button>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="start_over">
                <button type="submit" class="button-primary">Confirm start over</button>
            </form>
        </div>
    </section>
</div>
