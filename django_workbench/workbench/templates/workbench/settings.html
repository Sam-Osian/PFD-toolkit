{% extends "workbench/base.html" %}

{% block sidebar %}
    {% include "workbench/_sidebar.html" %}
{% endblock %}

{% block content %}
<div class="workbench settings-workbench">
    <section class="shell-panel reveal-up">
        <div class="section-card-header">
            <h3>Settings</h3>
        </div>

        <form method="post" class="form-card config-form">
            {% csrf_token %}

            <details class="expander workflow-clean-expander settings-category">
                <summary>
                    <span class="settings-category__heading">API settings</span>
                </summary>
                <div class="expander-content">
                    <div class="config-grid">
                        <div class="field-group">
                            <label for="provider_override">Model provider</label>
                            <select id="provider_override" name="provider_override">
                                <option value="OpenAI" {% if provider == 'OpenAI' %}selected{% endif %}>OpenAI</option>
                                <option value="OpenRouter" {% if provider == 'OpenRouter' %}selected{% endif %}>OpenRouter</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="model_name">Model</label>
                            <select id="model_name" name="model_name">
                                <option value="gpt-4.1-mini" {% if model_name == 'gpt-4.1-mini' %}selected{% endif %}>GPT 4.1 Mini (+speed, -accuracy)</option>
                                <option value="gpt-4.1" {% if model_name == 'gpt-4.1' %}selected{% endif %}>GPT 4.1 (+accuracy, -speed)</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label for="max_parallel_workers">Parallel workers</label>
                            <input id="max_parallel_workers" name="max_parallel_workers" type="number" min="1" max="32" value="{{ max_parallel_workers }}">
                        </div>
                    </div>

                    <div id="openai-fields" {% if provider == 'OpenRouter' %}class="hidden"{% endif %}>
                        <div class="config-grid">
                            <div class="field-group">
                                <label for="openai_api_key">OpenAI API key</label>
                                <input id="openai_api_key" name="openai_api_key" type="password" value="{{ openai_api_key }}">
                            </div>
                        </div>
                    </div>

                    <div id="openrouter-fields" {% if provider != 'OpenRouter' %}class="hidden"{% endif %}>
                        <div class="config-grid">
                            <div class="field-group">
                                <label for="openrouter_api_key">OpenRouter API key</label>
                                <input id="openrouter_api_key" name="openrouter_api_key" type="password" value="{{ openrouter_api_key }}">
                            </div>
                        </div>
                    </div>
                </div>
            </details>

            <details class="expander workflow-clean-expander settings-category">
                <summary>
                    <span class="settings-category__heading">Report loading settings</span>
                </summary>
                <div class="expander-content">
                    <div class="config-grid">
                        <div class="field-group">
                            <label for="report_start_date">Report start date</label>
                            <input id="report_start_date" name="report_start_date" type="date" value="{{ report_start_date }}">
                        </div>
                        <div class="field-group">
                            <label for="report_end_date">Report end date</label>
                            <input id="report_end_date" name="report_end_date" type="date" value="{{ report_end_date }}">
                        </div>
                    </div>

                    <div class="config-grid">
                        <div class="field-group">
                            <label for="n_reports">Limit recent reports</label>
                            <input id="n_reports" name="n_reports" type="number" min="1" step="1" value="{{ report_limit|default_if_none:'' }}" placeholder="Leave blank for all reports">
                        </div>
                        <div class="field-group">
                            <label class="checkbox">
                                <input type="checkbox" name="refresh" checked>
                                <span>Force refresh from remote dataset</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-actions">
                        <button type="submit" name="action" value="load_reports" class="button-primary" data-settings-load-open>Load reports</button>
                    </div>
                </div>
            </details>

            <details class="expander workflow-clean-expander settings-category">
                <summary>
                    <span class="settings-category__heading">Theme</span>
                </summary>
                <div class="expander-content">
                    <div class="settings-theme-picker" role="radiogroup" aria-label="Theme selection">
                        {% for theme in ui_theme_options %}
                        <label class="settings-theme-option">
                            <input
                                type="radio"
                                name="ui_theme"
                                value="{{ theme.id }}"
                                {% if ui_theme == theme.id %}checked{% endif %}
                            >
                            <span class="settings-theme-option__swatch settings-theme-option__swatch--{{ theme.id }}" aria-hidden="true"></span>
                            <span class="settings-theme-option__text">
                                <strong>{{ theme.name }}</strong>
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </details>

            <div class="settings-actions">
                <button type="submit" name="action" value="save_settings" class="button-secondary">Save settings</button>
            </div>
        </form>
    </section>

    <div class="confirm-modal-backdrop hidden" id="settings-load-reports-confirm" aria-modal="true" role="dialog" aria-labelledby="settings-load-reports-title">
        <section class="confirm-modal">
            <h3 id="settings-load-reports-title">Reload reports and replace this workspace?</h3>
            <p>Loading reports will refresh your existing workspace. Any unsaved workflow changes and generated outputs will be lost.</p>
            <div class="confirm-modal__actions">
                <button type="button" class="button-secondary" data-settings-load-cancel>Cancel</button>
                <button type="button" class="button-primary" data-settings-load-confirm>Confirm and reload</button>
            </div>
        </section>
    </div>
</div>
{% endblock %}
